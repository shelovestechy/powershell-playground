Osa vaatii Graph-moduulin ja kirjautumisen.

##Hae käyttäjä ja katso oleelliset attribuutit:

Get-MgUser -UserId "user@domain.com
" -Property "displayName,userPrincipalName,mail,accountEnabled,department,jobTitle" |
Select-Object DisplayName, UserPrincipalName, Mail, AccountEnabled, Department, JobTitle

##Listaa ryhmän jäsenet (vain käyttäjät):

$group = Get-MgGroup `
  -Filter "displayName eq 'esimerkkiryhmä'" `
  -ConsistencyLevel eventual

Get-MgGroupMember -GroupId $group.Id -All |
Where-Object {
  $_.AdditionalProperties.'@odata.type' -eq "#microsoft.graph.user"
} |
ForEach-Object {
  (Get-MgUser -UserId $_.Id -Property userPrincipalName).UserPrincipalName
}




##Etsi käyttäjät, jotka ovat disabled mutta silti ryhmässä

$group = Get-MgGroup `
  -Filter "displayName eq 'esimerkkiryhmä'" `
  -ConsistencyLevel eventual

Get-MgGroupMember -GroupId $group.Id -All |
Where-Object {
  $_.AdditionalProperties.'@odata.type' -eq "#microsoft.graph.user"
} |
ForEach-Object {
  Get-MgUser -UserId $_.Id -Property displayName,userPrincipalName,accountEnabled
} |
Where-Object {
  $_.AccountEnabled -eq $false
} |
Select-Object DisplayName, UserPrincipalName





##Jakeluryhmätyyppiset ryhmät (mail-enabled + non-security)

Get-MgGroup -All `
  -Filter "mailEnabled eq true and securityEnabled eq false" `
  -ConsistencyLevel eventual |
Select-Object DisplayName, Mail, Id |
Export-Csv `
  -Path ".\distribution-groups.csv" `
  -NoTypeInformation `
  -Encoding UTF8



Käyttäjät, joilla ei ole kirjautumista 90 päivään:

Get-MgUser -All `
  -Property displayName,userPrincipalName,signInActivity `
  -ConsistencyLevel eventual |
Where-Object {
  $_.SignInActivity.LastSignInDateTime -and
  ([datetime]$_.SignInActivity.LastSignInDateTime -lt (Get-Date).AddDays(-90))
} |
Select-Object `
  DisplayName,
  UserPrincipalName,
  @{Name="LastSignIn";Expression={$_.SignInActivity.LastSignInDateTime}} |
Export-Csv `
  -Path ".\stale-users-90d.csv" `
  -NoTypeInformation `
  -Encoding UTF8





##Guest-käyttäjät:

Get-MgUser -All `
  -Filter "userType eq 'Guest'" `
  -Property displayName,userPrincipalName,createdDateTime `
  -ConsistencyLevel eventual |
Select-Object DisplayName, UserPrincipalName, CreatedDateTime |
Export-Csv `
  -Path ".\guests.csv" `
  -NoTypeInformation `
  -Encoding UTF8




##Lisää käyttäjä ryhmään vain jos ei ole jo jäsen (idempotentti)

$groupName = "esimerkkiryhmä"
$userUpn   = "user@domain.com"

$group = Get-MgGroup `
  -Filter "displayName eq '$groupName'" `
  -ConsistencyLevel eventual

$user = Get-MgUser -UserId $userUpn
$members = Get-MgGroupMember -GroupId $group.Id -All

if (-not ($members.Id -contains $user.Id)) {
  New-MgGroupMember `
    -GroupId $group.Id `
    -DirectoryObjectId $user.Id
}

##Päivitä attribuutti vain jos arvo ei ole jo oikein

$user = Get-MgUser `
  -UserId "user@domain.com" `
  -Property department

if ($user.Department -ne "IT") {
  Update-MgUser `
    -UserId $user.Id `
    -Department "IT"
}




##Luo ryhmä vain jos sitä ei ole:

$groupName = "esimerkkiryhmä"

$existing = Get-MgGroup `
  -Filter "displayName eq '$groupName'" `
  -ConsistencyLevel eventual

if (-not $existing) {
  New-MgGroup `
    -DisplayName $groupName `
    -MailEnabled:$false `
    -MailNickname ($groupName -replace " ","") `
    -SecurityEnabled:$true
}


##Vertaa: pitäisi olla vs on (diff)

$should = @("a@example.com","b@example.com") | Sort-Object -Unique
$is     = @("a@example.com","c@example.com") | Sort-Object -Unique

Compare-Object $should $is

##Ryhmät ilman omistajia

Get-MgGroup -All -ConsistencyLevel eventual |
ForEach-Object {
  [pscustomobject]@{
    GroupName  = $_.DisplayName
    OwnerCount = (
      Get-MgGroupOwner `
        -GroupId $_.Id `
        -All `
        -ErrorAction SilentlyContinue
    ).Count
  }
} |
Where-Object { $_.OwnerCount -eq 0 } |
Export-Csv `
  -Path ".\groups-without-owners.csv" `
  -NoTypeInformation `
  -Encoding UTF8









